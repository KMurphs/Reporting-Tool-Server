pipeline {
    agent any
    parameters {
        string(name: 'TAG', defaultValue: 'latest', description: '')
        string(name: 'APP_NAME', defaultValue: 'reporting-mysql', description: '')
        string(name: 'REGISTRY_HOST', defaultValue: 'cloud.canister.io:5000', description: '')
    }
    environment {
        // https://stackoverflow.com/questions/35736377/reference-global-credentials-in-bash-script-in-jenkins-job
        REGISTRY_CREDS = credentials('canister-credentials')
        TEST_CONTAINER_NAME = "mysql_temp"
        TEST_PASSSWORD = "TestPassword!"

        //IMAGE_NAME = ${params.REGISTRY_HOST}/$REGISTRY_CREDS_USR/${params.APP_NAME}:${params.TAG}
    }
    stages {
        stage('Setup') {
            steps {
                script{
                    // https://stackoverflow.com/questions/43879733/jenkinsfile-declarative-pipeline-defining-dynamic-env-vars/43881731
                    imageName = "${params.REGISTRY_HOST}/$REGISTRY_CREDS_USR/${params.APP_NAME}:${params.TAG}"
                }
                sh "Testing login/logout to remote registry repository at $REGISTRY_HOST"
            }
        }                        
    }    

    post { 
        success { 
            sh 'echo "Pushing image to registry"'
            // https://stackoverflow.com/questions/35736377/reference-global-credentials-in-bash-script-in-jenkins-job/37171727#37171727
            sh "docker login --username=$REGISTRY_CREDS_USR --password=$REGISTRY_CREDS_PSW $REGISTRY_HOST"
            sh "docker push ${imageName}"
            sh "docker logout $REGISTRY_HOST"
            sh 'echo "$REGISTRY_CREDS --- $REGISTRY_CREDS_USR:$REGISTRY_CREDS_PSW" >> temp.txt'
            sh "cat temp.txt"
        }
    }
}
